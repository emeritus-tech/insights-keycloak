import{jsx as s,jsxs as v,Fragment as N}from"react/jsx-runtime";import{a as H}from"./policyRepresentation-LeM_FTje.js";import{u as G,a as _,aj as W,w as $,ae as J,b5 as Q,b6 as V,U as X,g as Y,d as Z,f as ee,b3 as se,B as j,l as k,bB as z,ab as ie,a3 as oe,b2 as ae,D as te,P as re,F as ne,y as U,O as le,ac as C,ad as F,a4 as ce,aq as E,R as pe,A as de,j as K,L as me,b7 as ue}from"./main-DXDh8SEc.js";import{useState as h,useRef as fe}from"react";import{u as he}from"./ConfirmDialog-o8TAA2Kj.js";import{F as ge}from"./FormAccess-Bcw0IOUQ.js";import{V as ye}from"./ViewHeader-DTd0a4sz.js";import{u as be}from"./useParams-5577fL9S.js";import{R as M}from"./NewPolicyDialog-CsSuVmVa.js";import"react-dom";import"./copy-icon-C4kUIpk5.js";import"./useToggle-K3Kx99tM.js";import"./Td-BmSS9qQq.js";import"./grip-vertical-icon-CgFEKIXW.js";import"./ClientSelect-DzH7E0lJ.js";import"./ClientScopeTypes-DaGfhuW4.js";import"./PaginatingTableToolbar-zbU1l_6-.js";import"./EmptyStateFooter-C_ktbNPy.js";import"./EmptyStateActions-CiPKPOdJ.js";import"./KeycloakDataTable-B3eTS_qk.js";import"./_baseFlatten-CMLUuI8z.js";import"./utils-DeGqqWSp.js";import"./filter-icon-Do5tIUfA.js";import"./GroupPickerDialog-B6DOUphD.js";import"./DataListItemRow-CavOLjhh.js";import"./CodeEditor-BFrRAdAy.js";import"./SwitchControl-BOCtuOhh.js";import"./AddRoleMappingModal-BqIKRo9T.js";import"./DatePicker-DrFczLpa.js";import"./FlexItem-c5qvFYFZ.js";import"./debounce-wvL-mo9n.js";const Se=({clientId:c,resourceId:e,preSelected:m})=>{const{adminClient:g}=G(),{t:P}=_(),{control:R,getValues:O,setValue:A,formState:{errors:r}}=W(),[u,n]=h([]),[i,y]=h([]),[d,f]=h(""),[b,D]=h(!1),S=fe(!0),w=O("scopes"),x=l=>l.map(t=>s(X,{value:t,children:t.name},t.id));return $(async()=>e?(e&&!S.current&&A("scopes",[]),S.current=!1,g.clients.listScopesByResource({id:c,resourceName:e})):g.clients.listAllScopes(Object.assign({id:c,deep:!1},d===""?null:{name:d})),l=>{n(l),d||y(l.filter(t=>w?.includes(t.id)))},[e,d]),s(J,{name:"scopes",defaultValue:m?[m]:[],control:R,rules:{validate:l=>l.length>0},render:({field:l})=>s(Q,{toggleId:"scopes",variant:V.typeaheadMulti,onToggle:t=>D(t),onFilter:t=>(f(t),x(u)),onClear:()=>{l.onChange([]),f("")},selections:i.map(t=>t.name),onSelect:t=>{const T=typeof t=="string"?i.find(p=>p.name===t):t,L=i.find(p=>p.id===T.id)?i.filter(p=>p.id!==T.id):[...i,T];l.onChange(L.map(p=>p.id)),y(L),f("")},isOpen:b,"aria-labelledby":P("scopes"),validated:r.scopes?"error":"default",isDisabled:!!m,typeAheadAriaLabel:P("scopes"),children:x(u)})})};function Xe(){const{adminClient:c}=G(),{t:e}=_(),m=Y({mode:"onChange"}),{control:g,reset:P,formState:{errors:R},handleSubmit:O}=m,A=Z(),{id:r,realm:u,permissionType:n,permissionId:i,selectedId:y}=be(),{addAlert:d,addError:f}=ee(),[b,D]=h(),[S,w]=h(!1),{hasAccess:x}=se(),l=!x("manage-authorization");$(async()=>{if(!i)return{};const[o,a,q,B]=await Promise.all([c.clients.findOnePermission({id:r,type:n,permissionId:i}),c.clients.getAssociatedResources({id:r,permissionId:i}),c.clients.getAssociatedPolicies({id:r,permissionId:i}),c.clients.getAssociatedScopes({id:r,permissionId:i})]);if(!o)throw new Error(e("notFound"));return{permission:o,resources:a.map(I=>I._id),policies:q.map(I=>I.id),scopes:B.map(I=>I.id)}},({permission:o,resources:a,policies:q,scopes:B})=>{P({...o,resources:a,policies:q,scopes:B}),o&&"resourceType"in o&&w(!!o.resourceType),D({...o,resources:a,policies:q})},[]);const t=async o=>{try{if(i)await c.clients.updatePermission({id:r,type:n,permissionId:i},o);else{const a=await c.clients.createPermission({id:r,type:n},o);D(a),A(ue({realm:u,id:r,permissionType:n,permissionId:a.id}))}d(e((i?"update":"create")+"PermissionSuccess"),k.success)}catch(a){f("permissionSaveError",a)}},[T,L]=he({titleKey:"deletePermission",messageKey:e("deletePermissionConfirm",{permission:b?.name}),continueButtonVariant:j.danger,continueButtonLabel:"confirm",onConfirm:async()=>{try{await c.clients.delPermission({id:r,type:n,permissionId:i}),d(e("permissionDeletedSuccess"),k.success),A(z({realm:u,clientId:r,tab:"permissions"}))}catch(o){f("permissionDeletedError",o)}}}),p=ie({control:g,name:"resources",defaultValue:[]});return b?v(N,{children:[s(L,{}),s(ye,{titleKey:i?b.name:`create${ae(n)}BasedPermission`,dropdownItems:i?[s(te,{"data-testid":"delete-resource",isDisabled:l,onClick:()=>T(),children:e("delete")},"delete")]:void 0}),s(re,{variant:"light",children:s(ge,{isHorizontal:!0,role:"manage-authorization",onSubmit:O(t),children:v(ne,{...m,children:[s(U,{name:"name",label:e("name"),labelIcon:e("permissionName"),rules:{required:e("required")}}),s(le,{name:"description",label:e("description"),labelIcon:e("permissionDescription"),rules:{maxLength:{value:255,message:e("maxLength",{length:255})}}}),s(C,{label:e("applyToResourceTypeFlag"),fieldId:"applyToResourceTypeFlag",labelIcon:s(F,{helpText:e("applyToResourceTypeFlagHelp"),fieldLabelId:"applyToResourceTypeFlag"}),children:s(ce,{id:"applyToResourceTypeFlag",name:"applyToResourceTypeFlag",label:e("on"),labelOff:e("off"),isChecked:S,onChange:(o,a)=>w(a),"aria-label":e("applyToResourceTypeFlag")})}),S?s(U,{name:"resourceType",label:e("resourceType"),labelIcon:e("resourceTypeHelp"),rules:{required:{value:n==="scope",message:e("required")}}}):v(C,{label:e("resource"),fieldId:"resources",labelIcon:s(F,{helpText:e("permissionResources"),fieldLabelId:"resources"}),isRequired:n!=="scope",children:[s(M,{name:"resources",clientId:r,permissionId:i,preSelected:n==="scope"?void 0:y,variant:n==="scope"?V.typeahead:V.typeaheadMulti,isRequired:n!=="scope"}),R.resources&&s(E,{message:e("required")})]}),n==="scope"&&v(C,{label:e("authorizationScopes"),fieldId:"scopes",labelIcon:s(F,{helpText:e("permissionScopesHelp"),fieldLabelId:"scopesSelect"}),isRequired:!0,children:[s(Se,{clientId:r,resourceId:p?.[0],preSelected:y}),R.scopes&&s(E,{message:e("required")})]}),s(C,{label:e("policies"),fieldId:"policies",labelIcon:s(F,{helpText:e("permissionPoliciesHelp"),fieldLabelId:"policies"}),children:s(M,{name:"policies",clientId:r,permissionId:i})}),s(C,{label:e("decisionStrategy"),labelIcon:s(F,{helpText:e("permissionDecisionStrategyHelp"),fieldLabelId:"decisionStrategy"}),fieldId:"policyEnforcementMode",hasNoPaddingTop:!0,children:s(J,{name:"decisionStrategy","data-testid":"decisionStrategy",defaultValue:H.UNANIMOUS,control:g,render:({field:o})=>s(N,{children:Object.values(H).map(a=>s(pe,{id:a,"data-testid":a,isChecked:o.value===a,isDisabled:l,name:"decisionStrategies",onChange:()=>o.onChange(a),label:e(`decisionStrategies.${a}`),className:"pf-v5-u-mb-md"},a))})})}),s(de,{children:v("div",{className:"pf-v5-u-mt-md",children:[s(K,{variant:j.primary,type:"submit","data-testid":"save",children:e("save")}),s(K,{variant:"link","data-testid":"cancel",component:o=>s(me,{...o,to:z({realm:u,clientId:r,tab:"permissions"})}),children:e("cancel")})]})})]})})})]}):s(oe,{})}export{Xe as default};
//# sourceMappingURL=PermissionDetails-BgHA6m4B.js.map
